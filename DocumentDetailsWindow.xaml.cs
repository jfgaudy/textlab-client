using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Windows;
using System.Windows.Controls;
using TextLabClient.Models;
using TextLabClient.Services;

namespace TextLabClient
{
    public partial class DocumentDetailsWindow : Window
    {
        private readonly TextLabApiService _apiService;
        private readonly Document _document;
        private DocumentContent? _documentContent;
        private DocumentVersions? _documentVersions;

        public DocumentDetailsWindow(Document document, TextLabApiService apiService)
        {
            InitializeComponent();
            _document = document;
            _apiService = apiService;
            
            // Initialiser l'affichage avec les informations de base
            InitializeDocumentInfo();
            
            // Charger les d√©tails complets
            _ = LoadDocumentDetailsAsync();
        }

        private void InitializeDocumentInfo()
        {
            // Informations de base depuis le document fourni
            DocumentTitleText.Text = _document.Title ?? "Document sans titre";
            DocumentPathText.Text = _document.GitPath ?? "";
            
            // M√©tadonn√©es
            DocumentIdText.Text = _document.Id;
            DocumentTitleDetailText.Text = _document.Title ?? "Sans titre";
            DocumentCategoryText.Text = !string.IsNullOrEmpty(_document.CategoryDisplay) 
                ? _document.CategoryDisplay 
                : (_document.Category ?? "Non cat√©goris√©");
            DocumentRepositoryText.Text = !string.IsNullOrEmpty(_document.RepositoryName) 
                ? _document.RepositoryName 
                : _document.RepositoryId;
            DocumentGitPathText.Text = _document.GitPath ?? "";
            DocumentVersionText.Text = !string.IsNullOrEmpty(_document.CurrentCommitSha) 
                ? _document.CurrentCommitSha.Substring(0, Math.Min(8, _document.CurrentCommitSha.Length))
                : (_document.Version ?? "N/A");
            // Debug complet de l'objet document
            Console.WriteLine($"=== DEBUG DOCUMENT ===");
            Console.WriteLine($"ID: {_document.Id}");
            Console.WriteLine($"Title: {_document.Title}");
            Console.WriteLine($"FileSizeBytes: {_document.FileSizeBytes} (type: {_document.FileSizeBytes.GetType()})");
            Console.WriteLine($"RepositoryName: '{_document.RepositoryName}'");
            Console.WriteLine($"GitPath: '{_document.GitPath}'");
            Console.WriteLine($"CurrentCommitSha: '{_document.CurrentCommitSha}'");
            Console.WriteLine($"==================");
            
            DocumentSizeText.Text = _document.FileSizeBytes > 0 
                ? $"{_document.FileSizeBytes:N0} octets" 
                : $"Taille inconnue (valeur: {_document.FileSizeBytes})";
            DocumentCreatedText.Text = _document.CreatedAt.ToString("dd/MM/yyyy HH:mm:ss");
            DocumentUpdatedText.Text = _document.UpdatedAt.ToString("dd/MM/yyyy HH:mm:ss");
            
            SetStatus("Chargement des d√©tails...");
        }

        private async System.Threading.Tasks.Task LoadDocumentDetailsAsync()
        {
            try
            {
                SetStatus("Chargement des d√©tails complets...");
                
                // Charger le contenu
                await LoadDocumentContent();
                
                // Charger les versions
                await LoadDocumentVersions();
                
                SetStatus("D√©tails charg√©s avec succ√®s");
            }
            catch (Exception ex)
            {
                SetStatus($"Erreur lors du chargement: {ex.Message}");
                MessageBox.Show($"Erreur lors du chargement des d√©tails:\n{ex.Message}", 
                              "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private async System.Threading.Tasks.Task LoadDocumentContent()
        {
            try
            {
                SetStatus("Chargement du contenu...");
                
                _documentContent = await _apiService.GetDocumentContentAsync(_document.Id);
                
                if (_documentContent != null)
                {
                    // Afficher le contenu
                    DocumentContentTextBox.Text = _documentContent.Content;
                    ContentSizeText.Text = $"{_documentContent.FileSizeBytes} octets";
                    
                    // Mettre √† jour les informations de fichier SEULEMENT si meilleures que celles existantes
                    Console.WriteLine($"LoadDocumentContent: _documentContent.FileSizeBytes = {_documentContent.FileSizeBytes}");
                    Console.WriteLine($"LoadDocumentContent: _document.FileSizeBytes = {_document.FileSizeBytes}");
                    
                    if (_documentContent.FileSizeBytes > 0 && _document.FileSizeBytes <= 0)
                    {
                        Console.WriteLine("Mise √† jour de la taille depuis _documentContent");
                        DocumentSizeText.Text = $"{_documentContent.FileSizeBytes:N0} octets";
                    }
                    else
                    {
                        Console.WriteLine("Conservation de la taille depuis _document (pas d'√©crasement)");
                    }
                    // Ne pas √©craser la taille si elle √©tait d√©j√† correcte dans _document
                    
                    if (!string.IsNullOrEmpty(_documentContent.RepositoryName))
                    {
                        DocumentRepositoryText.Text = _documentContent.RepositoryName;
                    }
                }
                else
                {
                    // Afficher un message informatif avec les donn√©es disponibles
                    var contentInfo = $@"üìã INFORMATIONS DU DOCUMENT

üî∏ ID: {_document.Id}
üî∏ Titre: {_document.Title ?? "Sans titre"}
üî∏ Repository: {_document.RepositoryName ?? _document.RepositoryId}
üî∏ Cat√©gorie: {(!string.IsNullOrEmpty(_document.CategoryDisplay) ? _document.CategoryDisplay : _document.Category) ?? "Non cat√©goris√©"}
üî∏ Chemin Git: {_document.GitPath ?? "Non sp√©cifi√©"}
üî∏ Taille: {(_document.FileSizeBytes > 0 ? $"{_document.FileSizeBytes:N0} octets" : "Inconnue")}
üî∏ Version: {(!string.IsNullOrEmpty(_document.CurrentCommitSha) ? _document.CurrentCommitSha.Substring(0, Math.Min(8, _document.CurrentCommitSha.Length)) : _document.Version ?? "N/A")}
üî∏ Cr√©√© le: {_document.CreatedAt:dd/MM/yyyy HH:mm:ss}
üî∏ Modifi√© le: {_document.UpdatedAt:dd/MM/yyyy HH:mm:ss}
üî∏ Cr√©√© par: {_document.CreatedBy ?? "Non sp√©cifi√©"}
üî∏ Visibilit√©: {(!string.IsNullOrEmpty(_document.VisibilityDisplay) ? _document.VisibilityDisplay : _document.Visibility) ?? "Non sp√©cifi√©e"}
üî∏ Actif: {(_document.IsActive ? "Oui" : "Non")}";

                    // Ajouter l'aper√ßu du contenu s'il est disponible
                    if (!string.IsNullOrEmpty(_document.ContentPreview))
                    {
                        contentInfo += $@"

üìÑ APER√áU DU CONTENU
{_document.ContentPreview}";
                    }

                    contentInfo += @"

‚ö†Ô∏è  CONTENU COMPLET NON DISPONIBLE
L'API ne fournit pas encore l'endpoint pour r√©cup√©rer le contenu complet des documents.
Les endpoints /content et /versions retournent actuellement des erreurs 404.

üìß Contactez l'administrateur de l'API pour activer ces fonctionnalit√©s.";

                    DocumentContentTextBox.Text = contentInfo;
                    ContentSizeText.Text = "Contenu indisponible";
                }
            }
            catch (Exception ex)
            {
                DocumentContentTextBox.Text = $"‚ùå Erreur lors du chargement du contenu:\n{ex.Message}";
                ContentSizeText.Text = "Erreur";
            }
        }

        private async System.Threading.Tasks.Task LoadDocumentVersions()
        {
            try
            {
                SetStatus("Chargement de l'historique...");
                
                _documentVersions = await _apiService.GetDocumentVersionsAsync(_document.Id);
                
                if (_documentVersions != null && _documentVersions.Versions.Count > 0)
                {
                    // Afficher les versions dans le DataGrid
                    VersionsDataGrid.ItemsSource = _documentVersions.Versions;
                    VersionCountText.Text = $"{_documentVersions.TotalVersions} version(s)";
                }
                else
                {
                    VersionCountText.Text = "Historique indisponible (API endpoint 404)";
                    
                    // Cr√©er une version factice pour expliquer le probl√®me
                    var dummyVersions = new List<object>
                    {
                        new
                        {
                            Version = "‚ùå Non disponible",
                            CommitSha = "N/A",
                            Author = "API endpoint manquant",
                            Date = DateTime.Now,
                            Message = "L'endpoint /versions retourne 404 Not Found",
                            ChangesCount = 0
                        }
                    };
                    VersionsDataGrid.ItemsSource = dummyVersions;
                }
            }
            catch (Exception ex)
            {
                VersionCountText.Text = $"Erreur: {ex.Message}";
            }
        }

        private void SetStatus(string message)
        {
            StatusText.Text = message;
        }

        private async void RefreshButton_Click(object sender, RoutedEventArgs e)
        {
            await LoadDocumentDetailsAsync();
        }

        private void CopyContentButton_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                if (!string.IsNullOrEmpty(DocumentContentTextBox.Text))
                {
                    Clipboard.SetText(DocumentContentTextBox.Text);
                    SetStatus("Contenu copi√© dans le presse-papiers");
                }
                else
                {
                    SetStatus("Aucun contenu √† copier");
                }
            }
            catch (Exception ex)
            {
                SetStatus($"Erreur lors de la copie: {ex.Message}");
            }
        }

        private void OpenInBrowserButton_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                // Construire l'URL GitHub bas√©e sur les informations du document
                if (!string.IsNullOrEmpty(_document.GitPath) && !string.IsNullOrEmpty(_document.RepositoryName))
                {
                    // Construire l'URL GitHub selon le repository
                    var githubUrl = "";
                    
                    if (_document.RepositoryName.ToLower() == "gaudylab")
                    {
                        githubUrl = $"https://github.com/jfgaudy/gaudylab/blob/main/{_document.GitPath}";
                    }
                    else if (_document.RepositoryName.ToLower().Contains("pac"))
                    {
                        // Adapter selon le repository PAC_Repo
                        githubUrl = $"https://github.com/jfgaudy/PAC_Repo/blob/main/{_document.GitPath}";
                    }
                    else
                    {
                        // Repository g√©n√©rique
                        githubUrl = $"https://github.com/jfgaudy/{_document.RepositoryName}/blob/main/{_document.GitPath}";
                    }
                    
                    Process.Start(new ProcessStartInfo
                    {
                        FileName = githubUrl,
                        UseShellExecute = true
                    });
                    
                    SetStatus($"Ouverture GitHub: {_document.RepositoryName}/{_document.GitPath}");
                }
                else
                {
                    SetStatus("Informations GitHub incompl√®tes");
                    MessageBox.Show($"Impossible de construire l'URL GitHub.\n\nRepository: {_document.RepositoryName ?? "Non sp√©cifi√©"}\nChemin Git: {_document.GitPath ?? "Non sp√©cifi√©"}", 
                                  "Information", MessageBoxButton.OK, MessageBoxImage.Information);
                }
            }
            catch (Exception ex)
            {
                SetStatus($"Erreur lors de l'ouverture: {ex.Message}");
                MessageBox.Show($"Erreur lors de l'ouverture du navigateur:\n{ex.Message}", 
                              "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void CloseButton_Click(object sender, RoutedEventArgs e)
        {
            this.Close();
        }
    }
} 